<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHYS101 Flipbook</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: #f4f4f4; display: flex; flex-direction: column; align-items: center; }
    #flipbook { width: 100%; max-width: 1200px; background: #fff; padding: 8px 0; }
    .page-image { width: 100%; height: auto; display: block; }
    #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000; }
    .lock-box { background: #fff; padding: 2rem; border-radius: 8px; text-align: center; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .lock-box input { width: 100%; padding: 0.5rem; font-size: 1rem; margin: 0.5rem 0; }
    .lock-box button { padding: 0.5rem 1rem; background: #007acc; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-top: 0.5rem; }
    .toolbar { margin: 0.5rem; display: flex; justify-content: center; gap: 0.6rem; flex-wrap: wrap; }
    button { padding: 0.45rem 0.9rem; border: none; border-radius: 8px; background: #007acc; color: white; font-size: 0.95rem; cursor: pointer; }
    button:hover { background: #005fa3; }
    #pageInput { width: 70px; padding: 0.3rem; font-size: 1rem; text-align: center; }
    .thumbbar { display: flex; overflow-x: auto; padding: 0.45rem; background: #fff; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; gap: 6px; }
    .thumbbar img { height: 80px; cursor: pointer; border: 2px solid transparent; }
    .thumbbar img.active { border: 2px solid #007acc; }
    #footer { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; padding: 0.5rem 1rem; position: relative; }
    #indexMenu { position: absolute; display: none; flex-direction: column; background: rgba(80,80,80,0.95); border-radius: 6px; padding: 0.4rem; width: max-content; z-index: 1200; bottom: 50px; }
    #indexMenu button { background: none; border: none; text-align: left; padding: 0.5rem 0.8rem; font-size: 0.9rem; cursor: pointer; color: #fff; white-space: nowrap; }
    #indexMenu button:hover { background: rgba(255,255,255,0.2); }
    
    #aiHelperToggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; z-index: 2000; }
    #notebookToggle { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; z-index: 2000; background: #ea4335; }
    #translateToggle { position: fixed; bottom: 140px; right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; z-index: 2000; background: #34a853; }
    
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2500; }
    .modal-content { background: #fff; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 10px; background: #eee; border: none; color: #333; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
    .modal-buttons { display: flex; gap: 10px; margin: 1rem 0; flex-wrap: wrap; justify-content: center; }
    .modal-response { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; line-height: 1.6; }
    
    .notebook-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; }
    .notebook-tab { padding: 0.5rem 1rem; background: none; border: none; cursor: pointer; color: #666; font-weight: 500; border-bottom: 3px solid transparent; }
    .notebook-tab.active { color: #ea4335; border-bottom-color: #ea4335; }
    .notebook-section { display: none; }
    .notebook-section.active { display: block; }
    .chat-container { display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding: 1rem; background: #f9f9f9; border-radius: 8px; }
    .chat-message { padding: 0.75rem; border-radius: 8px; max-width: 85%; }
    .chat-message.user { background: #e3f2fd; margin-left: auto; }
    .chat-message.assistant { background: #f0f0f0; }
    .chat-input-container { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .chat-input { flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; }
    .translate-options { display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap; }
    .translate-btn { flex: 1; min-width: 120px; }
    .summary-box { background: #f0f7ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #007acc; }
    .loading { display: inline-block; width: 8px; height: 8px; background: #007acc; border-radius: 50%; animation: pulse 1.5s infinite; margin: 0 2px; }
    @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
  </style>
</head>
<body>

<div id="lockScreen">
  <div class="lock-box">
    <h2>Enter Student ID</h2>
    <input id="idInput" type="text" maxlength="12" placeholder="Student ID" />
    <button onclick="app.checkID()">Unlock</button>
    <p id="idError" style="color: red; display: none;">Invalid ID</p>
  </div>
</div>

<div class="toolbar">
  <button onclick="app.firstPage()">First</button>
  <button onclick="app.prevPage()">Prev</button>
  <input id="pageInput" type="number" min="1" placeholder="Page #" />
  <button onclick="app.jumpToPage()">Go</button>
  <button onclick="app.nextPage()">Next</button>
  <button onclick="app.lastPage()">Last</button>
</div>

<div id="thumbbar" class="thumbbar"></div>
<div id="flipbook"></div>

<div id="footer">
  <div><button id="indexToggle" onclick="app.toggleIndex()">Index</button></div>
  <div id="pageCounter">Page 1 / 292</div>
  <div>
    <button onclick="app.toggleFullscreen()">Fullscreen</button>
    <button onclick="app.shareBook()">Share</button>
  </div>
  <div id="indexMenu"></div>
</div>

<button id="aiHelperToggle" onclick="app.openAI()">üß†</button>
<div id="aiHelperModal" class="modal" onclick="if(event.target === this) app.closeAI()">
  <div class="modal-content">
    <button class="modal-close" onclick="app.closeAI()">√ó</button>
    <h2>AI Study Helper</h2>
    <p id="aiChapter"></p>
    <div class="modal-buttons">
      <button onclick="app.aiExplain()">Explain</button>
      <button onclick="app.aiQuiz()">Quiz</button>
      <button onclick="app.aiRelate()">Life Sciences</button>
    </div>
    <div id="aiResponse" class="modal-response"></div>
    <div id="aiLoading" style="display:none;text-align:center;"><span class="loading"></span><span class="loading"></span><span class="loading"></span></div>
  </div>
</div>

<button id="notebookToggle" onclick="app.openNotebook()">üìö</button>
<div id="notebookModal" class="modal" onclick="if(event.target === this) app.closeNotebook()">
  <div class="modal-content">
    <button class="modal-close" onclick="app.closeNotebook()">√ó</button>
    <h2>Study Notebook</h2>
    <p id="notebookChapter"></p>
    <div class="notebook-tabs">
      <button class="notebook-tab active" onclick="app.switchTab('chat')">Chat</button>
      <button class="notebook-tab" onclick="app.switchTab('summary')">Summary</button>
      <button class="notebook-tab" onclick="app.switchTab('guide')">Study Guide</button>
    </div>
    <div id="chatSection" class="notebook-section active">
      <div id="chatContainer" class="chat-container"><div class="chat-message assistant">Hi! Ask me anything.</div></div>
      <div class="chat-input-container">
        <input id="chatInput" class="chat-input" placeholder="Ask..." onkeypress="if(event.key==='Enter') app.sendChat()" />
        <button onclick="app.sendChat()">Send</button>
      </div>
    </div>
    <div id="summarySection" class="notebook-section">
      <button onclick="app.genSummary()" style="width:100%;margin-bottom:1rem;">Generate</button>
      <div id="summaryResult"></div>
    </div>
    <div id="guideSection" class="notebook-section">
      <button onclick="app.genGuide()" style="width:100%;margin-bottom:1rem;">Generate</button>
      <div id="guideResult"></div>
    </div>
    <div id="notebookLoading" style="display:none;text-align:center;"><span class="loading"></span><span class="loading"></span><span class="loading"></span></div>
  </div>
</div>

<button id="translateToggle" onclick="app.openTranslate()">üåê</button>
<div id="translateModal" class="modal" onclick="if(event.target === this) app.closeTranslate()">
  <div class="modal-content">
    <button class="modal-close" onclick="app.closeTranslate()">√ó</button>
    <h2>Arabic Translation</h2>
    <p id="translateChapter"></p>
    <div class="translate-options">
      <button class="translate-btn" onclick="app.trans('concept')">Concept</button>
      <button class="translate-btn" onclick="app.trans('summary')">Summary</button>
    </div>
    <div id="translateResult"></div>
    <div id="translateLoading" style="display:none;text-align:center;"><span class="loading"></span><span class="loading"></span><span class="loading"></span></div>
  </div>
</div>

<script>
const app = {
  config: {
    totalPages: 292,
    imagePath: './images/Book_PHYS101_',
    thumbPath: './thumbs/Book_PHYS101_',
    chapters: [
      {title: 'CHAPTER 1 ‚Äì Physics and Measurements', page: 8},
      {title: 'CHAPTER 2 ‚Äì Solids and Elasticity', page: 40},
      {title: 'CHAPTER 3 ‚Äì Fluids', page: 62},
      {title: 'CHAPTER 4 ‚Äì Thermal Physics', page: 134},
      {title: 'CHAPTER 5 ‚Äì Waves and Sound', page: 216},
      {title: 'APPENDIX', page: 278}
    ]
  },
  
  allowedIDs: ['demo'],
  currentPage: 0,
  apiURL: 'https://ai-proxy-5nyos19ms-mohamed-s-projects-795931ab.vercel.app/api/proxy',
  
  async init() {
    try {
      const res = await fetch('./students.json');
      if (res.ok) this.allowedIDs = (await res.json()).allowed || ['demo'];
    } catch (err) { console.log('Using default IDs'); }
    this.renderThumbs();
    this.renderIndex();
    this.renderPage();
  },
  
  checkID() {
    const id = document.getElementById('idInput').value.trim();
    if (this.allowedIDs.includes(id)) {
      document.getElementById('lockScreen').style.display = 'none';
    } else {
      document.getElementById('idError').style.display = 'block';
    }
  },
  
  renderPage() {
    const fb = document.getElementById('flipbook');
    fb.innerHTML = '';
    const img = document.createElement('img');
    img.className = 'page-image';
    img.src = this.config.imagePath + this.currentPage + '.png';
    img.alt = 'Page ' + (this.currentPage + 1);
    img.onerror = function() { this.alt = 'Not available'; this.style.opacity = 0.5; };
    fb.appendChild(img);
    document.getElementById('pageCounter').textContent = 'Page ' + (this.currentPage + 1) + ' / ' + this.config.totalPages;
    this.highlightThumb();
  },
  
  renderThumbs() {
    const tb = document.getElementById('thumbbar');
    tb.innerHTML = '';
    for (let i = 0; i < this.config.totalPages; i++) {
      const img = document.createElement('img');
      img.src = this.config.thumbPath + i + '.jpg';
      img.loading = 'lazy';
      img.onclick = () => { this.currentPage = i; this.renderPage(); };
      img.onerror = function() { this.style.opacity = 0.6; };
      tb.appendChild(img);
    }
  },
  
  highlightThumb() {
    const imgs = document.querySelectorAll('.thumbbar img');
    imgs.forEach((img, i) => { img.classList.toggle('active', i === this.currentPage); });
  },
  
  renderIndex() {
    const menu = document.getElementById('indexMenu');
    menu.innerHTML = '';
    this.config.chapters.forEach(ch => {
      const btn = document.createElement('button');
      btn.textContent = ch.title;
      btn.onclick = () => { this.currentPage = ch.page; this.renderPage(); this.toggleIndex(); };
      menu.appendChild(btn);
    });
  },
  
  getCurrentChapter() {
    let ch = this.config.chapters[0];
    for (let i = this.config.chapters.length - 1; i >= 0; i--) {
      if (this.currentPage >= this.config.chapters[i].page) { ch = this.config.chapters[i]; break; }
    }
    return ch;
  },
  
  nextPage() { if (this.currentPage < this.config.totalPages - 1) { this.currentPage++; this.renderPage(); } },
  prevPage() { if (this.currentPage > 0) { this.currentPage--; this.renderPage(); } },
  firstPage() { this.currentPage = 0; this.renderPage(); },
  lastPage() { this.currentPage = this.config.totalPages - 1; this.renderPage(); },
  jumpToPage() {
    const v = parseInt(document.getElementById('pageInput').value, 10);
    if (!isNaN(v) && v >= 1 && v <= this.config.totalPages) { this.currentPage = v - 1; this.renderPage(); }
  },
  toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  },
  shareBook() {
    if (navigator.share) navigator.share({title: 'PHYS101 Flipbook', url: window.location.href});
    else if (navigator.clipboard) navigator.clipboard.writeText(window.location.href);
  },
  toggleIndex() {
    const menu = document.getElementById('indexMenu');
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
  },
  
  openAI() {
    document.getElementById('aiChapter').textContent = 'Chapter: ' + this.getCurrentChapter().title;
    document.getElementById('aiResponse').innerHTML = '';
    document.getElementById('aiHelperModal').style.display = 'flex';
  },
  closeAI() { document.getElementById('aiHelperModal').style.display = 'none'; },
  
  aiExplain() {
    const concept = prompt('What concept?', 'e.g., Pascal Principle');
    if (concept) this.callAI('Explain ' + concept + ' from ' + this.getCurrentChapter().title);
  },
  aiQuiz() {
    this.callAI('Create 2 quiz questions from ' + this.getCurrentChapter().title);
  },
  aiRelate() {
    this.callAI('How does ' + this.getCurrentChapter().title + ' relate to biology or medicine?');
  },
  
  async callAI(prompt) {
    const loading = document.getElementById('aiLoading');
    const response = document.getElementById('aiResponse');
    loading.style.display = 'block';
    response.innerHTML = '';
    try {
      const res = await fetch(this.apiURL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: [{role: 'user', content: prompt}]})});
      const data = await res.json();
      const text = data.text || data.response || 'No response';
      response.innerHTML = marked.parse(text);
    } catch (err) {
      response.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
    } finally {
      loading.style.display = 'none';
    }
  },
  
  openNotebook() {
    document.getElementById('notebookChapter').textContent = this.getCurrentChapter().title;
    document.getElementById('notebookModal').style.display = 'flex';
  },
  closeNotebook() { document.getElementById('notebookModal').style.display = 'none'; },
  
  switchTab(tab) {
    document.querySelectorAll('.notebook-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.notebook-section').forEach(s => s.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Section').classList.add('active');
  },
  
  async sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    const container = document.getElementById('chatContainer');
    const userDiv = document.createElement('div');
    userDiv.className = 'chat-message user';
    userDiv.textContent = msg;
    container.appendChild(userDiv);
    input.value = '';
    try {
      const res = await fetch(this.apiURL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: [{role: 'user', content: msg}]})});
      const data = await res.json();
      const text = data.text || data.response || 'No response';
      const assistantDiv = document.createElement('div');
      assistantDiv.className = 'chat-message assistant';
      assistantDiv.innerHTML = marked.parse(text);
      container.appendChild(assistantDiv);
      container.scrollTop = container.scrollHeight;
    } catch (err) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'chat-message assistant';
      errorDiv.textContent = 'Error: ' + err.message;
      container.appendChild(errorDiv);
    }
  },
  
  async genSummary() {
    const loading = document.getElementById('notebookLoading');
    const result = document.getElementById('summaryResult');
    loading.style.display = 'block';
    result.innerHTML = '';
    try {
      const prompt = 'Summarize ' + this.getCurrentChapter().title + '. Include concepts, equations, applications.';
      const res = await fetch(this.apiURL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: [{role: 'user', content: prompt}]})});
      const data = await res.json();
      const text = data.text || data.response || 'No response';
      result.innerHTML = '<div class="summary-box">' + marked.parse(text) + '</div>';
    } catch (err) {
      result.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
    } finally {
      loading.style.display = 'none';
    }
  },
  
  async genGuide() {
    const loading = document.getElementById('notebookLoading');
    const result = document.getElementById('guideResult');
    loading.style.display = 'block';
    result.innerHTML = '';
    try {
      const prompt = 'Create study guide for ' + this.getCurrentChapter().title + '. Include objectives, terms, equations, practice problems.';
      const res = await fetch(this.apiURL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: [{role: 'user', content: prompt}]})});
      const data = await res.json();
      const text = data.text || data.response || 'No response';
      result.innerHTML = '<div class="summary-box">' + marked.parse(text) + '</div>';
    } catch (err) {
      result.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
    } finally {
      loading.style.display = 'none';
    }
  },
  
  openTranslate() {
    document.getElementById('translateChapter').textContent = this.getCurrentChapter().title;
    document.getElementById('translateResult').innerHTML = '';
    document.getElementById('translateModal').style.display = 'flex';
  },
  closeTranslate() { document.getElementById('translateModal').style.display = 'none'; },
  
  async trans(type) {
    const loading = document.getElementById('translateLoading');
    const result = document.getElementById('translateResult');
    loading.style.display = 'block';
    result.innerHTML = '';
    let prompt = '';
    if (type === 'concept') {
      const concept = prompt('Enter concept:', 'e.g., Pressure');
      if (!concept) { loading.style.display = 'none'; return; }
      prompt = 'Translate and explain ' + concept + ' to Arabic.';
    } else {
      prompt = 'Translate ' + this.getCurrentChapter().title + ' to Arabic.';
    }
    try {
      const res = await fetch(this.apiURL, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: [{role: 'user', content: prompt}]})});
      const data = await res.json();
      const text = data.text || data.response || 'No response';
      result.innerHTML = '<div class="summary-box">' + marked.parse(text) + '</div>';
    } catch (err) {
      result.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
    } finally {
      loading.style.display = 'none';
    }
  }
};

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowRight') app.nextPage();
  if (e.key === 'ArrowLeft') app.prevPage();
});

let touchStart = 0;
document.getElementById('flipbook').addEventListener('touchstart', e => { touchStart = e.touches[0].screenX; }, {passive: true});
document.getElementById('flipbook').addEventListener('touchend', e => {
  const diff = e.changedTouches[0].screenX - touchStart;
  if (Math.abs(diff) > 40) { diff > 0 ? app.prevPage() : app.nextPage(); }
}, {passive: true});

app.init();
</script>
</body>
</html>
