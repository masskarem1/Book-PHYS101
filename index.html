<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PHYS101 Interactive Flipbook</title>

<!-- Styles -->
<style>
  body {
    font-family: "Arial", sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  #flipbook {
    width: 90%;
    height: 90vh;
    margin: 20px auto;
    position: relative;
    background: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .page {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .page-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  #controls {
    margin: 10px auto;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  button {
    padding: 8px 14px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
  }

  button:hover { background: #0056b3; }

  #thumbBar {
    display: flex;
    overflow-x: auto;
    gap: 5px;
    margin-top: 10px;
    padding: 5px;
    background: #eee;
    border-top: 1px solid #ccc;
    justify-content: center;
  }

  #thumbBar img {
    width: 80px;
    height: 110px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: 0.2s;
  }

  #thumbBar img:hover {
    border: 2px solid #007bff;
  }

  /* Overlay for translated Arabic text */
  #overlay-translation {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    color: #111;
  }

  .overlay-line {
    position: absolute;
    direction: rtl;
    text-align: right;
    font-size: 1rem;
    line-height: 1.3;
    background: rgba(255,255,255,0.85);
    border-radius: 4px;
    padding: 2px 4px;
  }
</style>

<!-- MathJax -->
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<!-- Tesseract.js for OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
</head>

<body>
<h2>üìò PHYS101 Interactive Flipbook</h2>

<div id="controls">
  <button id="prevPage">‚¨Ö Previous</button>
  <button id="nextPage">Next ‚û°</button>
  <button id="translateBtn">üåê Translate Page to Arabic</button>
  <button id="hideTranslateBtn" style="display:none;">‚ùå Hide Arabic</button>
</div>

<div id="flipbook">
  <div class="page">
    <img class="page-image" src="./images/Book_PHYS101_0.png" alt="Page 1">
    <div id="overlay-translation"></div>
  </div>
</div>

<div id="thumbBar"></div>

<script>
const totalPages = 5; // update according to number of images
let currentPage = 0;
const GEMINI_API_KEY = "AIzaSyAntGKIXHhHIWkYT7R6rPlpBk0tZuLtlD8"; // ‚Üê Add your Gemini API key here (optional)
const flipbook = document.getElementById("flipbook");
const overlay = document.getElementById("overlay-translation");
const hideTranslateBtn = document.getElementById("hideTranslateBtn");

// Load a specific page
function loadPage() {
  flipbook.innerHTML = `
    <div class="page">
      <img class="page-image" src="./images/Book_PHYS101_${currentPage}.png" alt="Page ${currentPage+1}">
      <div id="overlay-translation"></div>
    </div>`;
  MathJax.typesetPromise();
  renderThumbs();
}

// Render page thumbnails
function renderThumbs() {
  const thumbBar = document.getElementById("thumbBar");
  thumbBar.innerHTML = "";
  for (let i = 0; i < totalPages; i++) {
    const thumb = document.createElement("img");
    thumb.src = `./images/Book_PHYS101_${i}.png`;
    thumb.onclick = () => { currentPage = i; loadPage(); };
    thumbBar.appendChild(thumb);
  }
}

// Translation function
async function translateCurrentPage() {
  const overlay = document.getElementById("overlay-translation");
  const pageImg = document.querySelector(".page-image");
  if (!pageImg) return alert("Page image not ready.");

  overlay.style.display = "block";
  overlay.textContent = "üîé Running OCR...";

  try {
    const ocrResult = await Tesseract.recognize(pageImg.src, "eng", { logger: m => {} });
    const { lines } = ocrResult.data;

    if (!lines?.length) {
      overlay.textContent = "‚ö†Ô∏è No readable English text found.";
      return;
    }

    overlay.innerHTML = "";
    const imgWidth = ocrResult.data.image?.dims?.width || pageImg.naturalWidth;
    const imgHeight = ocrResult.data.image?.dims?.height || pageImg.naturalHeight;

    for (const line of lines) {
      const engLine = (line.text || "").trim();
      if (!engLine) continue;

      // Translate each line
      let translated = engLine;
      if (GEMINI_API_KEY) {
        try {
          const resp = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: `Translate to Arabic (preserve meaning and math):\n${engLine}` }] }]
              })
            }
          );
          const data = await resp.json();
          translated = data.candidates?.[0]?.content?.parts?.[0]?.text || engLine;
        } catch (err) {
          console.warn("Translation error:", err);
        }
      }

      // Bounding box positioning
      const { x0, y0, x1, y1 } = line.bbox;
      const leftPct = (x0 / imgWidth) * 100;
      const topPct = (y0 / imgHeight) * 100;
      const widthPct = ((x1 - x0) / imgWidth) * 100;
      const heightPct = ((y1 - y0) / imgHeight) * 100;

      const div = document.createElement("div");
      div.className = "overlay-line";
      div.innerHTML = translated;
      div.style.left = `${leftPct}%`;
      div.style.top = `${topPct}%`;
      div.style.width = `${widthPct}%`;
      div.style.height = `${heightPct}%`;

      overlay.appendChild(div);
    }

    hideTranslateBtn.style.display = "inline-block";
    MathJax.typesetPromise();

  } catch (err) {
    console.error("OCR/Translate error:", err);
    overlay.textContent = "‚ùå Translation failed.";
  }
}

// Hide Arabic overlay
hideTranslateBtn.onclick = () => {
  overlay.innerHTML = "";
  hideTranslateBtn.style.display = "none";
};

// Page navigation
document.getElementById("nextPage").onclick = () => {
  if (currentPage < totalPages - 1) { currentPage++; loadPage(); }
};
document.getElementById("prevPage").onclick = () => {
  if (currentPage > 0) { currentPage--; loadPage(); }
};

// Translate button
document.getElementById("translateBtn").onclick = translateCurrentPage;

// Initialize
loadPage();
</script>
</body>
</html>
