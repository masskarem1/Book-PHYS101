<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHYS101 Flipbook</title>

  <!-- Markdown + MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async id="MathJax-script"
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      background: #f0f2f5;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #lockScreen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: white; z-index: 10;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #flipbook-container { display: none; margin-top: 70px; text-align: center; }
    .page-container {
      position: relative;
      display: inline-block;
    }
    #page-img {
      width: 80%;
      max-height: 80vh;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #overlay-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 80%;
      height: 100%;
      padding: 20px;
      color: #111;
      background: rgba(255,255,255,0.7);
      border-radius: 10px;
      overflow-y: auto;
      text-align: right;
      direction: rtl;
      font-size: 1.1em;
      display: none;
      white-space: pre-wrap;
    }
    .controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    #ai-helper {
      margin-top: 20px;
      width: 80%;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: left;
      max-height: 40vh;
      overflow-y: auto;
    }
    input[type=text] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <!-- Lock screen -->
  <div id="lockScreen">
    <h2>üîí Enter Student ID</h2>
    <input id="studentIdInput" type="text" placeholder="Your ID" />
    <button id="unlockBtn">Unlock</button>
    <p id="lockMsg"></p>
  </div>

  <!-- Flipbook -->
  <div id="flipbook-container">
    <h2>üìò PHYS101 Textbook</h2>

    <div class="page-container">
      <img id="page-img" src="" alt="Book Page" />
      <div id="overlay-text"></div>
    </div>

    <div class="controls">
      <button id="firstBtn">‚èÆÔ∏è First</button>
      <button id="prevBtn">‚óÄÔ∏è Prev</button>
      <span id="pageNum">Page 1 / N</span>
      <button id="nextBtn">Next ‚ñ∂Ô∏è</button>
      <button id="lastBtn">Last ‚è≠Ô∏è</button>
      <button id="translateBtn">üåê Translate Page</button>
      <button id="hideOverlayBtn" style="display:none;">‚ùå Hide Translation</button>
    </div>

    <div id="ai-helper">
      <h3>ü§ñ AI Study Helper</h3>
      <input id="aiQuestion" type="text" placeholder="Ask about this page..." style="width: 70%;">
      <button id="askBtn">Ask</button>
      <div id="aiResponse"></div>
    </div>
  </div>

  <script>
    // Pages
    const pages = [
      "pages/page1.jpg",
      "pages/page2.jpg",
      "pages/page3.jpg"
    ];
    let currentPage = 0;

    const lockScreen = document.getElementById("lockScreen");
    const flipbook = document.getElementById("flipbook-container");
    const imgEl = document.getElementById("page-img");
    const overlayText = document.getElementById("overlay-text");
    const pageNum = document.getElementById("pageNum");
    const aiResponseEl = document.getElementById("aiResponse");
    const hideOverlayBtn = document.getElementById("hideOverlayBtn");
    const GEMINI_API_KEY = "AIzaSyAntGKIXHhHIWkYT7R6rPlpBk0tZuLtlD8"; // Replace with your Gemini key

    // Unlock Logic
    document.getElementById("unlockBtn").onclick = async () => {
      const id = document.getElementById("studentIdInput").value.trim();
      if (!id) return alert("Enter your student ID.");
      const res = await fetch("students.json");
      const students = await res.json();

      if (students.includes(id)) {
        lockScreen.style.display = "none";
        flipbook.style.display = "block";
        showPage(0);
      } else {
        document.getElementById("lockMsg").innerText = "‚ùå Invalid ID";
      }
    };

    // Show Page
    function showPage(index) {
      currentPage = Math.max(0, Math.min(index, pages.length - 1));
      imgEl.src = pages[currentPage];
      pageNum.innerText = `Page ${currentPage + 1} / ${pages.length}`;
      overlayText.style.display = "none";
      hideOverlayBtn.style.display = "none";
    }

    // Navigation
    document.getElementById("firstBtn").onclick = () => showPage(0);
    document.getElementById("prevBtn").onclick = () => showPage(currentPage - 1);
    document.getElementById("nextBtn").onclick = () => showPage(currentPage + 1);
    document.getElementById("lastBtn").onclick = () => showPage(pages.length - 1);

    // AI Helper
    document.getElementById("askBtn").onclick = async () => {
      const q = document.getElementById("aiQuestion").value.trim();
      if (!q) return;
      aiResponseEl.innerHTML = "<em>Thinking...</em>";

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Explain this physics concept: ${q}` }] }]
          }),
        }
      );

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response found.";
      aiResponseEl.innerHTML = marked.parse(text);
      if (window.MathJax) MathJax.typesetPromise([aiResponseEl]);
    };

    // Translate Page ‚Üí Arabic Overlay
    document.getElementById("translateBtn").onclick = async () => {
      overlayText.style.display = "block";
      overlayText.innerHTML = "<em>Extracting English text...</em>";
      hideOverlayBtn.style.display = "none";

      try {
        const result = await Tesseract.recognize(imgEl.src, 'eng');
        const englishText = result.data.text.trim();
        if (!englishText) {
          overlayText.innerHTML = "‚ö†Ô∏è No readable text found.";
          return;
        }

        overlayText.innerHTML = "<em>Translating to Arabic...</em>";

        const translationResponse = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `Translate this English text into clear Arabic for students:\n${englishText}` }] }]
            }),
          }
        );

        const translationData = await translationResponse.json();
        const arabic = translationData.candidates?.[0]?.content?.parts?.[0]?.text || "‚ùå Translation failed.";
        overlayText.innerText = arabic;
        hideOverlayBtn.style.display = "inline-block";
      } catch (err) {
        overlayText.innerHTML = "‚ùå Error: " + err.message;
      }
    };

    hideOverlayBtn.onclick = () => {
      overlayText.style.display = "none";
      hideOverlayBtn.style.display = "none";
    };
  </script>
</body>
</html>
